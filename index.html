<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dan's Book Tracker</title>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
.book-item { background: #fff; border-radius: 0.5rem; padding: 1rem; box-shadow: 0 2px 6px rgba(0,0,0,0.05); transition: transform 0.2s, box-shadow 0.2s; }
.book-item:hover { transform: translateY(-4px); box-shadow: 0 8px 16px rgba(0,0,0,0.15); }
.book-top { font-weight: 700; font-size: 1.5rem; margin-bottom: 0.5rem; }
.book-content { display:flex; gap:1rem; }
.book-cover { width: 120px; height: 180px; object-fit: cover; border-radius:0.25rem; }
.book-info { display:flex; flex-direction:column; justify-content:flex-start; color:#374151; }
.progress-container { position: relative; height: 1.5rem; background: #e5e7eb; border-radius: 0.75rem; }
.progress-bar { height: 1.5rem; border-radius: 0.75rem; background: #34d399; }
.progress-marker { position: absolute; width: 2px; background: #ef4444; top: 0; bottom: 0; }
.progress-text { position: absolute; width: 100%; text-align: center; font-weight: bold; top:0; line-height:1.5rem; color:#111827; }
</style>
</head>
<body class="p-6">

<h1 class="text-3xl text-center mb-6">Dan's Book Tracker</h1>

<div class="grid md:grid-cols-2 gap-6 mb-6">

  <!-- Currently Reading -->
  <div id="currentlyReading" class="bg-white p-4 rounded-lg shadow-lg overflow-auto max-h-[400px]"></div>

  <!-- Stats -->
  <div id="stats" class="bg-white p-4 rounded-lg shadow-lg text-center space-y-2"></div>

  <!-- Pie Charts -->
  <div class="bg-white p-4 rounded-lg shadow-lg flex justify-around flex-wrap">
    <div class="text-center">
      <div class="chart-title">Genre</div>
      <canvas id="genreChart" width="150" height="150"></canvas>
    </div>
    <div class="text-center">
      <div class="chart-title">Gender</div>
      <canvas id="genderChart" width="150" height="150"></canvas>
    </div>
    <div class="text-center">
      <div class="chart-title">Language</div>
      <canvas id="languageChart" width="150" height="150"></canvas>
    </div>
  </div>

  <!-- Bars -->
  <div>
    <div id="fictionBar" class="bg-white p-4 rounded-lg shadow-lg relative mb-4"></div>
    <div id="readProgressBar" class="bg-white p-4 rounded-lg shadow-lg relative"></div>
  </div>

</div>

<!-- Book list -->
<div id="bookList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-4"></div>

<!-- Debug -->
<div id="debug" class="mt-12 p-4 bg-gray-100 rounded shadow text-sm overflow-x-auto"></div>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSDLnokY9AAjmaXbQ4Ofk-jH6eK1mn9bXcgAid1xWU_2MbtoraDDL5IzoEYT7PPT-numSfmt0EJoS6a/pub?gid=1531654911&single=true&output=csv";
let genreChartInstance=null, genderChartInstance=null, languageChartInstance=null;

async function fetchBooks(){
    const debugDiv = document.getElementById("debug");
    try {
        const res = await fetch(CSV_URL);
        const text = await res.text();
        debugDiv.innerHTML = `<p>CSV fetch status: ${res.status}</p>`;
        const { data } = Papa.parse(text,{header:false,skipEmptyLines:true});
        const books = data.slice(5).map((row,index)=>({
            Book: row[0]||"",
            Author: row[1]||"",
            Fiction: row[2]||"",
            Read: row[3]||"",
            "Date Finished": row[4]||"",
            Rating: row[5]||"",
            Notes: row[6]||"",
            Gender: row[7]||"",
            Language: row[8]||"",
            Genre: row[9]?.trim() || "Other",
            Cover: row[10]||"",
            _rowIndex:index+6
        }));
        debugDiv.innerHTML += `<p>Total books parsed: ${books.length}</p>`;
        return books;
    } catch(err){
        debugDiv.innerHTML += `<p style="color:red;">Failed to fetch CSV: ${err}</p>`;
        return [];
    }
}

function renderStars(rating){
    if(!rating) return "-";
    let r = parseFloat(r);
    const fullStars = Math.floor(r);
    const halfStar = (r - fullStars) >= 0.5 ? 1 : 0;
    const emptyStars = 5 - fullStars - halfStar;
    return '★'.repeat(fullStars) + (halfStar?'⯨':'') + '☆'.repeat(emptyStars);
}

function renderCurrentlyReading(books){
    const div = document.getElementById("currentlyReading");
    const current = books.filter(b=>!b.Read || b.Read.toLowerCase()!=="finished");
    if(current.length===0){ div.innerHTML="No books currently reading"; return; }
    div.innerHTML = `<p class="font-semibold mb-2">Currently Reading</p>`;
    current.forEach(b=>{
        div.innerHTML += `
            <div class="book-item">
                <p class="book-top">${b.Book}</p>
                <div class="book-content">
                    ${b.Cover ? `<img class="book-cover" src="${b.Cover}" alt="cover">` : ""}
                    <div class="book-info">
                        <p><strong>Author:</strong> ${b.Author}</p>
                        <p><strong>Genre:</strong> ${b.Genre || b.Fiction}</p>
                        <p><strong>Fiction/Non-Fiction:</strong> ${b.Fiction}</p>
                        <p><strong>Language:</strong> ${b.Language}</p>
                        <p><strong>Rating:</strong> ${renderStars(b.Rating)}</p>
                        <p><strong>Date Finished:</strong> ${b["Date Finished"]}</p>
                    </div>
                </div>
            </div>`;
    });
}

function renderBooks(books){
    const bookList=document.getElementById("bookList");
    bookList.innerHTML="";
    books.forEach(b=>{
        bookList.innerHTML += `
            <div class="book-item">
                <p class="book-top">${b.Book}</p>
                <div class="book-content">
                    ${b.Cover ? `<img class="book-cover" src="${b.Cover}" alt="cover">` : ""}
                    <div class="book-info">
                        <p><strong>Author:</strong> ${b.Author}</p>
                        <p><strong>Genre:</strong> ${b.Genre || b.Fiction}</p>
                        <p><strong>Fiction/Non-Fiction:</strong> ${b.Fiction}</p>
                        <p><strong>Language:</strong> ${b.Language}</p>
                        <p><strong>Rating:</strong> ${renderStars(b.Rating)}</p>
                        <p><strong>Date Finished:</strong> ${b["Date Finished"]}</p>
                    </div>
                </div>
            </div>`;
    });
}

// Stats, bars, charts functions: use the previous working version exactly

async function init(){
    const books = await fetchBooks();
    const notFinished=books.filter(b=>!b.Read || b.Read.toLowerCase()!=="finished");
    const finished=books.filter(b=>b.Read && b.Read.toLowerCase()==="finished");
    const orderedBooks=[...notFinished,...finished];

    renderCurrentlyReading(orderedBooks);
    renderStatsAndBars(orderedBooks);
    renderBooks(finished);
    renderCharts(orderedBooks);
}

init();
</script>
</body>
</html>