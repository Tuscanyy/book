<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dan's Book Tracker</title>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
.star { color: gold; font-size: 1.1em; }
.progress-marker { position: absolute; width: 2px; background: red; top: 0; bottom: 0; }
.progress-container { position: relative; height: 1.5rem; }
.chart-container { width: 10rem; height: 10rem; position: relative; }
</style>
</head>
<body class="bg-gray-50 font-sans p-6">

<h1 class="text-3xl font-bold mb-6 text-center text-gradient bg-gradient-to-r from-purple-400 via-pink-500 to-red-500 bg-clip-text text-transparent">ðŸ“š Dan's Book Tracker</h1>

<!-- 2x2 grid -->
<div class="grid md:grid-cols-2 gap-6 mb-6">

  <!-- A: Currently Reading -->
  <div id="currentlyReading" class="bg-white p-4 rounded-lg shadow-lg overflow-auto max-h-[400px]"></div>

  <!-- B: Stats -->
  <div class="space-y-4">
    <div id="stats" class="bg-white p-4 rounded-lg shadow-lg text-center"></div>
  </div>

  <!-- C: Pie Charts Row -->
  <div class="bg-white p-4 rounded-lg shadow-lg flex justify-around">
    <div class="chart-container">
      <canvas id="genreChart"></canvas>
    </div>
    <div class="chart-container">
      <canvas id="genderChart"></canvas>
    </div>
    <div class="chart-container">
      <canvas id="languageChart"></canvas>
    </div>
  </div>

  <!-- D: Fiction / Non-Fiction Bar & Reading Progress -->
  <div class="space-y-4">
    <div id="fictionBar" class="bg-white p-4 rounded-lg shadow-lg"></div>
    <div id="readProgressBar" class="bg-white p-4 rounded-lg shadow-lg"></div>
  </div>

</div>

<!-- All books list -->
<div id="bookList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

<!-- Debug Section -->
<div id="debug" class="mt-12 p-4 bg-gray-100 rounded shadow text-sm overflow-x-auto"></div>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSDLnokY9AAjmaXbQ4Ofk-jH6eK1mn9bXcgAid1xWU_2MbtoraDDL5IzoEYT7PPT-numSfmt0EJoS6a/pub?gid=1531654911&single=true&output=csv";
let genreChartInstance=null, genderChartInstance=null, languageChartInstance=null;

async function fetchBooks(){
    const debugDiv = document.getElementById("debug");
    try {
        const res = await fetch(CSV_URL);
        const text = await res.text();
        debugDiv.innerHTML = `<p>CSV fetch status: ${res.status}</p>`;
        const { data } = Papa.parse(text,{header:false,skipEmptyLines:true});
        const books = data.slice(5).map((row,index)=>({
            Book: row[0]||"",
            Author: row[1]||"",
            Fiction: row[2]||"",
            Read: row[3]||"",
            "Date Finished": row[4]||"",
            Rating: row[5]||"",
            Notes: row[6]||"",
            Gender: row[7]||"",
            Language: row[8]||"",
            Genre: row[9]?.trim() || "Other",
            _rowIndex:index+6
        }));
        debugDiv.innerHTML += `<p>Total books parsed: ${books.length}</p>`;
        return books;
    } catch(err){
        debugDiv.innerHTML += `<p style="color:red;">Failed to fetch CSV: ${err}</p>`;
        return [];
    }
}

// Generate star rating (supports half stars)
function renderStars(rating){
    if(!rating) return "-";
    let r = parseFloat(rating);
    const fullStars = Math.floor(r);
    const halfStar = (r - fullStars) >= 0.5 ? 1 : 0;
    const emptyStars = 5 - fullStars - halfStar;
    return 'â˜…'.repeat(fullStars) + (halfStar?'â¯¨':'') + 'â˜†'.repeat(emptyStars);
}

function renderCurrentlyReading(books){
    const div = document.getElementById("currentlyReading");
    const current = books.filter(b=>!b.Read || b.Read.toLowerCase()!=="finished");
    if(current.length===0){ div.innerHTML="No books currently reading"; return; }
    div.innerHTML = `<p class="text-lg font-semibold mb-2">ðŸ“– Currently Reading</p>`;
    current.forEach(b=>{
        div.innerHTML += `
            <div class="bg-gray-50 rounded shadow p-2 mb-2 hover:shadow-lg transition">
                <p class="font-semibold">${b.Book}</p>
                <p>Author: ${b.Author || "Unknown"}</p>
                <p>Genre: ${b.Genre || b.Fiction || "Unknown"}</p>
                <p>Read: ${b.Read || "Not marked"}</p>
            </div>`;
    });
}

function renderBooks(books){
    const bookList=document.getElementById("bookList");
    bookList.innerHTML="";
    books.forEach(b=>{
        const stars = renderStars(b.Rating);
        bookList.innerHTML += `
            <div class="bg-white p-4 rounded shadow hover:shadow-lg transition">
                <p class="font-bold text-lg mb-1">${b.Book}</p>
                <p><strong>Author:</strong> ${b.Author}</p>
                <p><strong>Genre:</strong> ${b.Genre || b.Fiction}</p>
                <p><strong>Fiction/Non-Fiction:</strong> ${b.Fiction}</p>
                <p><strong>Gender:</strong> ${b.Gender}</p>
                <p><strong>Language:</strong> ${b.Language}</p>
                <p><strong>Read:</strong> ${b.Read}</p>
                <p><strong>Date Finished:</strong> ${b["Date Finished"]}</p>
                <p><strong>Rating:</strong> <span class="star">${stars}</span></p>
            </div>
        `;
    });
}

function renderStatsAndBars(books){
    const totalBooks = books.length;
    const finishedBooks = books.filter(b=>b.Read && b.Read.toLowerCase()==="finished").length;
    const remaining = Math.max(100-finishedBooks,0);
    const avgRating = books.filter(b=>b.Rating).length ? (books.filter(b=>b.Rating).reduce((s,b)=>s+Number(b.Rating),0)/books.filter(b=>b.Rating).length).toFixed(2) : "-";

    document.getElementById("stats").innerHTML=`
        <p class="text-lg"><strong>Total Books:</strong> ${totalBooks}</p>
        <p class="text-lg"><strong>Finished:</strong> ${finishedBooks}</p>
        <p class="text-lg"><strong>Remaining to 100:</strong> ${remaining}</p>
        <p class="text-lg"><strong>Average Rating:</strong> ${avgRating}</p>
    `;

    // Reading progress with marker
    const today=new Date(), start=new Date(today.getFullYear(),0,1), end=new Date(today.getFullYear(),11,31);
    const yearFraction = (today-start)/(end-start);
    const expectedBooks = Math.floor(100*yearFraction);
    const percent = Math.min((finishedBooks/100)*100,100);
    const markerPercent = Math.min((expectedBooks/100)*100,100);

    document.getElementById("readProgressBar").innerHTML=`
        <p class="text-lg font-semibold mb-1">Reading Progress</p>
        <div class="progress-container w-full bg-gray-300 rounded-full relative">
            <div class="bg-green-500 h-6 rounded-full" style="width:${percent}%"></div>
            <div class="progress-marker" style="left:${markerPercent}%"></div>
        </div>
        <p class="text-sm mt-1">Finished: ${finishedBooks}/100. Expected by now: ${expectedBooks}</p>
    `;

    // Fiction/Non-Fiction Bar
    const fictionCount = books.filter(b=>b.Fiction.toLowerCase().includes("fiction")).length;
    const nonFictionCount = books.filter(b=>b.Fiction.toLowerCase().includes("non-fiction")).length;
    const totalCount = fictionCount+nonFictionCount;
    const fictionPercent = totalCount ? (fictionCount/totalCount*100):0;
    const nonFictionPercent = totalCount ? (nonFictionCount/totalCount*100):0;
    document.getElementById("fictionBar").innerHTML=`
        <p class="text-lg font-semibold mb-1">Fiction vs Non-Fiction</p>
        <div class="w-full bg-gray-300 rounded-full h-6 flex">
            <div class="bg-blue-500 h-6 rounded-l" style="width:${fictionPercent}%"></div>
            <div class="bg-yellow-500 h-6 rounded-r" style="width:${nonFictionPercent}%"></div>
        </div>
        <p class="text-sm mt-1">Fiction: ${fictionCount}, Non-Fiction: ${nonFictionCount}</p>
    `;
}

function renderPieChart(id, dataObj){
    const labels = Object.keys(dataObj);
    const data = Object.values(dataObj);
    const ctx = document.getElementById(id);
    if(id==="genreChart" && genreChartInstance) genreChartInstance.destroy();
    if(id==="genderChart" && genderChartInstance) genderChartInstance.destroy();
    if(id==="languageChart" && languageChartInstance) languageChartInstance.destroy();
    const chart = new Chart(ctx,{
        type:'pie',
        data:{labels,data,datasets:[{data,backgroundColor:["#f87171","#60a5fa","#34d399","#facc15","#a78bfa","#fb7185","#fbbf24","#38bdf8","#a3e635","#c084fc"]}]},
        options:{
            responsive:true,
            maintainAspectRatio:false,
            aspectRatio:1,
            plugins:{
                legend:{position:'bottom',labels:{boxWidth:12,padding:8}}
            }
        }
    });
    if(id==="genreChart") genreChartInstance=chart;
    if(id==="genderChart") genderChartInstance=chart;
    if(id==="languageChart") languageChartInstance=chart;
}

function renderCharts(books){
    const genreCount={}, genderCount={}, langCount={};
    books.forEach(b=>{
        const g = b.Genre.trim() || "Other";
        genreCount[g]=(genreCount[g]||0)+1;
        if(b.Gender) genderCount[b.Gender]=(genderCount[b.Gender]||0)+1;
        if(b.Language) langCount[b.Language]=(langCount[b.Language]||0)+1;
    });
    renderPieChart("genreChart",genreCount);
    renderPieChart("genderChart",genderCount);
    renderPieChart("languageChart",langCount);
}

async function init(){
    const books = await fetchBooks();
    const notFinished=books.filter(b=>!b.Read || b.Read.toLowerCase()!=="finished");
    const finished=books.filter(b=>b.Read && b.Read.toLowerCase()==="finished");
    const orderedBooks=[...notFinished,...finished];

    renderCurrentlyReading(orderedBooks);
    renderStatsAndBars(orderedBooks);
    renderBooks(finished);
    renderCharts(orderedBooks);
}

init();
</script>
</body>
</html>