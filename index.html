<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>2026 Reading Tracker</title>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 font-sans p-6">

<h1 class="text-3xl font-bold mb-6 text-center">ðŸ“š 2026 Reading Tracker</h1>

<!-- Stats Section -->
<div id="stats" class="mb-6 text-center"></div>

<!-- Genre Pie Chart -->
<div class="max-w-md mx-auto mb-6">
<canvas id="genreChart"></canvas>
</div>

<!-- Books List -->
<div id="bookList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSDLnokY9AAjmaXbQ4Ofk-jH6eK1mn9bXcgAid1xWU_2MbtoraDDL5IzoEYT7PPT-numSfmt0EJoS6a/pub?gid=1531654911&single=true&output=csv";

// Helper to fetch Open Library data
async function fetchBookDetails(title, author){
    try {
        const query = encodeURIComponent(title + " " + author);
        const res = await fetch(`https://openlibrary.org/search.json?q=${query}&limit=1`);
        if(!res.ok) return null;
        const data = await res.json();
        if(data.numFound === 0) return null;
        const book = data.docs[0];
        return {
            cover: book.cover_i ? `https://covers.openlibrary.org/b/id/${book.cover_i}-M.jpg` : "",
            publish_year: book.first_publish_year || "",
            subjects: book.subject ? book.subject.slice(0,5) : []
        };
    } catch(err) {
        console.warn("Failed to fetch book details:", title, err);
        return null;
    }
}

async function fetchBooks(){
    const res = await fetch(CSV_URL);
    const text = await res.text();
    const { data } = Papa.parse(text, { header: false, skipEmptyLines: true });
    
    const books = data.slice(5).map((row,index) => ({
        Book: row[0] || "",
        Author: row[1] || "",
        Genre: row[2] || "",
        Read: row[3] || "",
        "Date Finished": row[4] || "",
        Rating: row[5] || "",
        Notes: row[6] || "",
        _rowIndex: index+6
    }));

    // fetch details from Open Library for each book
    for(let book of books){
        const details = await fetchBookDetails(book.Book, book.Author);
        book.cover = details && details.cover ? details.cover : "https://via.placeholder.com/128x192?text=No+Cover";
        book.publish_year = details ? details.publish_year : "";
        book.subjects = details ? details.subjects : [];
    }

    return books;
}

function renderBooks(books){
    const bookList = document.getElementById("bookList");
    bookList.innerHTML = "";
    if(books.length === 0){
        bookList.innerHTML = "<p class='text-center col-span-full'>No books found.</p>";
        return;
    }

    books.forEach(book=>{
        const card = document.createElement("div");
        card.className = "bg-white p-4 rounded shadow hover:shadow-lg transition flex flex-col items-center";
        card.innerHTML = `
            <img src="${book.cover}" class="w-32 h-48 mb-2 object-cover rounded shadow">
            <h2 class="font-bold text-lg mb-1 text-center">${book.Book}</h2>
            <p class="text-sm text-center"><strong>Author:</strong> ${book.Author || "Unknown"}</p>
            <p class="text-sm text-center"><strong>Genre:</strong> ${book.Genre || "Unknown"}</p>
            <p class="text-sm text-center"><strong>Read:</strong> ${book.Read || "Not marked"}</p>
            <p class="text-sm text-center"><strong>Date Finished:</strong> ${book["Date Finished"] || "-"}</p>
            <p class="text-sm text-center"><strong>Rating:</strong> ${book.Rating || "-"}</p>
            <p class="text-sm text-center"><strong>Published:</strong> ${book.publish_year || "-"}</p>
            <p class="text-sm text-center"><strong>Subjects:</strong> ${book.subjects.join(", ")}</p>
        `;
        bookList.appendChild(card);
    });
}

function renderStats(books){
    const total = books.length;
    const finished = books.filter(b => b.Read && b.Read.toLowerCase()==="finished").length;
    const remaining = Math.max(100-finished,0);
    const ratedBooks = books.filter(b=>b.Rating);
    const avgRating = ratedBooks.length ? (ratedBooks.reduce((sum,b)=>sum+Number(b.Rating),0)/ratedBooks.length).toFixed(2) : "-";

    document.getElementById("stats").innerHTML = `
        <p class="text-lg"><strong>Total Books:</strong> ${total}</p>
        <p class="text-lg"><strong>Finished:</strong> ${finished}</p>
        <p class="text-lg"><strong>Remaining to 100:</strong> ${remaining}</p>
        <p class="text-lg"><strong>Average Rating:</strong> ${avgRating}</p>
    `;

    const genreCount = {};
    books.forEach(b=>{
        const g = b.Genre || "Unknown";
        genreCount[g] = (genreCount[g]||0)+1;
    });

    new Chart(document.getElementById("genreChart"),{
        type:'pie',
        data:{
            labels: Object.keys(genreCount),
            datasets:[{
                label:"Genre Distribution",
                data: Object.values(genreCount),
                backgroundColor: [
                    "#f87171","#60a5fa","#34d399","#facc15","#a78bfa",
                    "#fb7185","#fbbf24","#38bdf8","#a3e635","#c084fc"
                ]
            }]
        }
    });
}

// Load everything
fetchBooks().then(books=>{
    renderStats(books);
    renderBooks(books);
});
</script>

</body>
</html>